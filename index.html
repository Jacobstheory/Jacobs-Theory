<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jacob’s Theory — Phase 1: The Fall</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0f1115;--panel:#141821;--ink:#e8eaf0;--muted:#a9b0be;
      --accent:#66d9ef;--accent-2:#8be9a8;--border:#212634;
      --link:#8bd5ff;--link-hover:#bce8ff;--active:#1e2635;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
      display:grid; grid-template-columns:300px 1fr; min-height:100%;
    }
    /* Sidebar */
    aside{
      position:sticky; top:0; align-self:start; height:100vh; overflow:auto;
      background:var(--panel); border-right:1px solid var(--border); padding:14px 12px;
    }
    .brand{font-weight:700; letter-spacing:.2px; margin:0 0 6px}
    .hint{color:var(--muted); font-size:.85rem; margin:0 0 12px}

    /* Simple Downloads (like your screenshot) */
    .downloads{margin:10px 0 14px}
    .downloads h4{margin:0 0 6px; font-size:.9rem; letter-spacing:.3px; color:#cfe3ff}
    .downloads ul{list-style:disc; padding-left:18px; margin:6px 0 0}
    .downloads a{color:var(--link); text-decoration:none}
    .downloads a:hover{color:var(--link-hover); text-decoration:underline}

    /* Controls + filter */
    .controls{display:flex; gap:8px; margin:10px 0; flex-wrap:wrap}
    .btn{
      background:transparent; color:var(--muted); border:1px solid var(--border);
      padding:6px 8px; border-radius:8px; cursor:pointer; font-size:.85rem;
    }
    .btn:hover{color:var(--ink); border-color:#2a3244}
    .filter{width:100%; padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:#0c0f14; color:var(--ink); margin-bottom:10px}

    /* TOC list */
    nav ul{list-style:none; margin:0; padding:0}
    nav li{margin:0; padding:0}
    .node{
      display:flex; align-items:center; gap:6px; width:100%;
      padding:6px 6px; border-radius:8px; cursor:pointer; border:1px solid transparent;
    }
    .node:hover{background:#161c25}
    .node.active{background:var(--active); border-color:#263043}
    .node .chev{width:16px;height:16px;display:inline-flex;align-items:center;justify-content:center;color:var(--muted);transition:transform .15s}
    .collapsed>.chev{transform:rotate(-90deg)}
    .node a{color:var(--link); text-decoration:none; flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .node a:hover{color:var(--link-hover)}
    .level-1{margin-left:0}
    .level-2{margin-left:14px}
    .level-3{margin-left:28px}
    .divider{height:1px;background:var(--border);margin:10px 0}

    /* Content */
    main{padding:34px 40px; max-width:1100px}
    main h1, main h2, main h3{scroll-margin-top:18px}
    main a{color:var(--accent)}
    hr{border:0; border-top:1px solid var(--border); margin:26px 0}

    @media (max-width: 880px){
      body{grid-template-columns:1fr}
      aside{position:static; height:auto}
    }
    .anchor-highlight{position:relative}
    .anchor-highlight::before{
      content:""; position:absolute; left:-14px; top:9px; bottom:9px; width:3px;
      background:var(--accent-2); border-radius:3px; opacity:.4;
    }
  </style>
</head>
<body>
  <aside>
    <h3 class="brand">Contents</h3>

    <!-- DOWNLOADS (PDF + EPUB only, simple list) -->
    <section class="downloads" aria-labelledby="downloads-title">
      <h4 id="downloads-title">Downloads</h4>
      <ul>
        <li><a href="Jacobs%20Theory%20-%20Phase%201%20The%20Fall.pdf" target="_blank" rel="noopener">Download PDF</a></li>
        <li><a href="Jacobs%20Theory%20-%20Phase%201%20The%20Fall%20-%20Unknown.epub" target="_blank" rel="noopener">Download EPUB</a></li>
      </ul>
    </section>

    <p class="hint">Auto-grouped by H1 → H2 → H3</p>
    <input id="filter" class="filter" placeholder="Filter headings…" aria-label="Filter headings">

    <div class="controls">
      <button class="btn" id="expandAll" type="button">Expand all</button>
      <button class="btn" id="collapseAll" type="button">Collapse all</button>
    </div>

    <nav id="toc" aria-label="Table of contents"><ul></ul></nav>
  </aside>

  <main id="content">
    <!-- content.html gets embedded here -->
    <p style="color:var(--muted)">Loading content…</p>
  </main>

  <script>
  (async function(){
    // Load content.html INTO the page
    const host = document.getElementById('content');
    try{
      const resp = await fetch('content.html', {cache:'no-store'});
      host.innerHTML = await resp.text();
    }catch(e){
      host.innerHTML = "<p style='color:#f88'>Could not load content.html</p>";
      return;
    }

    // Collect H1/H2/H3
    const headings = Array.from(host.querySelectorAll('h1, h2, h3')).filter(h=>h.textContent.trim());
    const slugCounts = new Map();
    const slugify = str=>{
      const base = str.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
      const n = slugCounts.get(base)||0; slugCounts.set(base,n+1);
      return n?`${base}-${n}`:base;
    };
    headings.forEach(h=>{ if(!h.id) h.id = slugify(h.textContent.trim()); });

    // Build nested tree H1 > H2 > H3
    function levelOf(h){ return +h.tagName.substring(1); }
    const root = {children:[], level:0};
    let stack=[root];
    headings.forEach(h=>{
      const L=levelOf(h), node={level:L,text:h.textContent.trim(),id:h.id,children:[]};
      while(stack.length && stack.at(-1).level>=L){stack.pop();}
      stack.at(-1).children.push(node); stack.push(node);
    });

    // Render TOC
    const tocUl=document.getElementById('toc').firstElementChild;
    function render(nodes,level,parentUl){
      nodes.forEach(node=>{
        const li=document.createElement('li');
        const row=document.createElement('div');
        row.className=`node level-${Math.min(level,3)}`;

        if(node.children.length){
          const chev=document.createElement('span');chev.className='chev';chev.textContent='▾';row.appendChild(chev);
        }else{const spacer=document.createElement('span');spacer.style.width='16px';row.appendChild(spacer);}

        const a=document.createElement('a');a.href='#'+node.id;a.textContent=node.text;row.appendChild(a);
        li.appendChild(row);parentUl.appendChild(li);

        if(node.children.length){
          const childUl=document.createElement('ul');childUl.hidden=false;li.appendChild(childUl);
          row.addEventListener('click',ev=>{
            if(ev.target.tagName.toLowerCase()==='a') return;
            childUl.hidden=!childUl.hidden;
            row.classList.toggle('collapsed', childUl.hidden);
          });
          render(node.children,level+1,childUl);
        }
      });
    }
    render(root.children,1,tocUl);

    // Filter (keeps parents visible if a child matches)
    const filter=document.getElementById('filter');
    filter.addEventListener('input',()=>{
      const q=filter.value.trim().toLowerCase();
      function apply(ul){
        let any=false;
        ul.querySelectorAll('li').forEach(li=>{
          // direct child UL detection without :scope
          let row=null, childUl=null;
          for(const el of li.children){ if(el.classList?.contains('node')) row=el; if(el.tagName==='UL') childUl=el; }
          const a=row?.querySelector('a');
          const self=(a?.textContent.toLowerCase()||'').includes(q);
          let child=false;
          if(childUl){ child=apply(childUl); if(q){ childUl.hidden=false; row?.classList.remove('collapsed'); } }
          const show=!q || self || child;
          li.style.display=show?'':'none'; any=any||show;
        });
        return any;
      }
      apply(tocUl);
    });

    // Utility to iterate rows + direct child ULs (no :scope)
    function pairs() {
      const rootUl = tocUl;
      return Array.from(rootUl.querySelectorAll('li')).map(li => {
        let row=null, childUl=null;
        for(const el of li.children){ if(el.classList?.contains('node')) row=el; if(el.tagName==='UL') childUl=el; }
        const isTop = li.parentElement === rootUl;
        return { li, row, childUl, isTop, rootUl };
      });
    }

    // Expand all
    document.getElementById('expandAll').addEventListener('click', () => {
      pairs().forEach(p => { if (p.childUl) p.childUl.hidden = false; if (p.row) p.row.classList.remove('collapsed'); });
    });

    // Collapse all (keep top-level open)
    document.getElementById('collapseAll').addEventListener('click', () => {
      const ps = pairs();
      ps.forEach(p => { if (p.childUl) p.childUl.hidden = true; if (p.row) p.row.classList.add('collapsed'); });
      ps.forEach(p => { if (p.isTop) { if (p.row) p.row.classList.remove('collapsed'); if (p.childUl) p.childUl.hidden = false; } });
    });

    // Active section highlight
    const links=Array.from(tocUl.querySelectorAll('a'));
    const byId=new Map(links.map(a=>[a.getAttribute('href').slice(1),a]));
    const obs=new IntersectionObserver(entries=>{
      entries.forEach(e=>{
        const a=byId.get(e.target.id); if(!a) return;
        if(e.isIntersecting){ links.forEach(x=>x.parentElement.classList.remove('active')); a.parentElement.classList.add('active'); }
      });
    },{rootMargin:'-40% 0px -55% 0px',threshold:[0,1]});
    headings.forEach(h=>{ h.classList.add('anchor-highlight'); obs.observe(h); });

    // Smooth scroll (stay on this page)
    document.addEventListener('click',e=>{
      const a=e.target.closest('a[href^="#"]'); if(!a) return;
      const id=a.getAttribute('href').slice(1);
      const t=document.getElementById(id);
      if(t){ e.preventDefault(); t.scrollIntoView({behavior:'smooth'}); history.replaceState(null,'','#'+id); }
    });
  })();
  </script>
</body>
</html>
