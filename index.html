<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jacob’s Theory — Phase 1: The Fall</title>
  <style>
    :root{
      --bg:#0f1115;--panel:#141821;--ink:#e8eaf0;--muted:#a9b0be;
      --accent:#66d9ef;--accent-2:#8be9a8;--border:#212634;
      --link:#8bd5ff;--link-hover:#bce8ff;--active:#1e2635;
      --chip:#0c0f14;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
      display:grid; grid-template-columns:300px 1fr; min-height:100%;
    }
    /* Sidebar */
    aside{
      position:sticky; top:0; align-self:start; height:100vh; overflow:auto;
      background:var(--panel); border-right:1px solid var(--border); padding:14px 12px;
    }
    .brand{font-weight:700; letter-spacing:.2px; margin:0 0 10px}
    .hint{color:var(--muted); font-size:.85rem; margin:2px 0 12px}
    .controls{display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap}
    .btn{
      background:transparent; color:var(--muted); border:1px solid var(--border);
      padding:6px 8px; border-radius:8px; cursor:pointer; font-size:.85rem;
    }
    .btn:hover{color:var(--ink); border-color:#2a3244}
    .filter{width:100%; padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:#0c0f14; color:var(--ink); margin-bottom:10px}
    nav ul{list-style:none; margin:0; padding:0}
    nav li{margin:0; padding:0}
    .node{
      display:flex; align-items:center; gap:6px; width:100%;
      padding:6px 6px; border-radius:8px; cursor:pointer; border:1px solid transparent;
    }
    .node:hover{background:#161c25}
    .node.active{background:var(--active); border-color:#263043}
    .node .chev{
      width:16px; height:16px; display:inline-flex; align-items:center; justify-content:center;
      color:var(--muted); transition:transform .15s ease;
    }
    .collapsed>.chev{transform:rotate(-90deg)}
    .node a{
      color:var(--link); text-decoration:none; flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .node a:hover{color:var(--link-hover)}
    .level-1{margin-left:0}
    .level-2{margin-left:14px}
    .level-3{margin-left:28px}

    /* Downloads card */
    .dl-card{
      border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:12px;
      background:linear-gradient(180deg,#121828 0%, #0f1421 100%);
    }
    .dl-card h4{margin:0 0 10px 0; font-size:13px; letter-spacing:.4px; text-transform:uppercase; color:#cfe3ff}
    .dl-grid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .dl-btn{
      display:flex; justify-content:center; align-items:center; gap:6px;
      padding:9px 10px; border-radius:10px; border:1px solid var(--border);
      background:var(--chip); color:var(--ink); font-weight:600; font-size:.9rem; text-decoration:none;
    }
    .dl-btn:hover{background:#131a29}
    .dl-tag{font-size:.75rem; color:#cfe3ff; opacity:.9}

    /* Content */
    main{padding:34px 40px; max-width:1100px}
    main h1, main h2, main h3{scroll-margin-top:18px}
    main a{color:var(--accent)}
    hr{border:0; border-top:1px solid var(--border); margin:26px 0}

    /* Responsive */
    @media (max-width: 880px){
      body{grid-template-columns:1fr}
      aside{position:static; height:auto}
    }

    /* Active-heading side bar highlight */
    .anchor-highlight{position:relative}
    .anchor-highlight::before{
      content:""; position:absolute; left:-14px; top:9px; bottom:9px; width:3px;
      background:var(--accent-2); border-radius:3px; opacity:.4;
    }
  </style>
</head>
<body>
  <aside>
    <h3 class="brand">Contents</h3>

    <!-- DOWNLOADS AT TOP -->
    <section class="dl-card" aria-labelledby="downloads-title">
      <h4 id="downloads-title">Downloads</h4>
      <div class="dl-grid">
        <a class="dl-btn" href="Jacobs%20Theory%20-%20Phase%201%20The%20Fall.pdf" target="_blank" rel="noopener">
          <span>PDF</span> <span class="dl-tag">Phase 1</span>
        </a>
        <a class="dl-btn" href="Jacobs%20Theory%20-%20Phase%201%20The%20Fall%20-%20Unknown.epub" target="_blank" rel="noopener">
          <span>EPUB</span> <span class="dl-tag">Phase 1</span>
        </a>
        <a class="dl-btn" href="content.html" target="_blank" rel="noopener">
          <span>Full HTML</span>
        </a>
      </div>
      <p class="hint" style="margin:8px 0 0">Files are free to mirror; preserve integrity.</p>
    </section>

    <p class="hint">Auto-grouped by H1 → H2 → H3</p>

    <input id="filter" class="filter" placeholder="Filter headings…" aria-label="Filter headings">

    <div class="controls">
      <button class="btn" id="expandAll" type="button">Expand all</button>
      <button class="btn" id="collapseAll" type="button">Collapse all</button>
    </div>

    <nav id="toc" aria-label="Table of contents"><ul></ul></nav>
  </aside>

  <main id="content">
    <!-- Loaded dynamically from content.html -->
    <p style="color:var(--muted)">Loading content…</p>
  </main>

  <script>
  (async function(){
    // 1) Load your book content into the page (so links jump in-place)
    const host = document.getElementById('content');
    try{
      const resp = await fetch('content.html', {cache:'no-store'});
      const html = await resp.text();
      host.innerHTML = html;
    }catch(e){
      host.innerHTML = "<p style='color:#f88'>Could not load content.html</p>";
      return;
    }

    // 2) Collect H1/H2/H3 in order
    const headings = Array.from(host.querySelectorAll('h1, h2, h3'))
      .filter(h => h.textContent.trim().length);

    // Give each heading a stable unique ID if it doesn't already have one
    const slugCounts = new Map();
    function slugify(str){
      const base = str.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
      const c = slugCounts.get(base) || 0; slugCounts.set(base, c+1);
      return c ? `${base}-${c}` : base;
    }
    headings.forEach(h=>{ if(!h.id){ h.id = slugify(h.textContent.trim()); } });

    // 3) Build nested tree (H1 > H2 > H3)
    function levelOf(h){ return +h.tagName.substring(1); }
    const root = { children:[], level:0, text:'ROOT', id:null };
    let stack = [root];
    headings.forEach(h=>{
      const L = levelOf(h);
      const node = { level:L, text:h.textContent.trim(), id:h.id, children:[] };
      while(stack.length && stack.at(-1).level >= L){ stack.pop(); }
      stack.at(-1).children.push(node);
      stack.push(node);
    });

    // 4) Render the TOC with collapsible groups
    const tocUl = document.getElementById('toc').firstElementChild;
    function render(nodes, level, parentUl){
      nodes.forEach(node=>{
        const li = document.createElement('li');

        const row = document.createElement('div');
        row.className = `node level-${Math.min(level,3)}`;

        // Chevron if there are children
        let chev = null;
        if(node.children.length){
          chev = document.createElement('span');
          chev.className = 'chev';
          chev.innerHTML = '▾';
          row.appendChild(chev);
        }else{
          const spacer = document.createElement('span');
          spacer.style.width='16px';
          row.appendChild(spacer);
        }

        // Link
        const a = document.createElement('a');
        a.href = '#'+node.id;
        a.textContent = node.text;
        row.appendChild(a);

        li.appendChild(row);
        parentUl.appendChild(li);

        if(node.children.length){
          const childUl = document.createElement('ul');
          childUl.style.margin=0; childUl.style.padding=0; childUl.hidden = false;
          li.appendChild(childUl);

          // toggle collapse when clicking row (not the link)
          row.addEventListener('click', (ev)=>{
            if(ev.target.tagName.toLowerCase() === 'a') return; // let links work
            childUl.hidden = !childUl.hidden;
            row.classList.toggle('collapsed', childUl.hidden);
          });

          render(node.children, level+1, childUl);
        }
      });
    }
    render(root.children, 1, tocUl);

    // 5) Smarter filter: show parents if any child matches
    const filter = document.getElementById('filter');
    filter.addEventListener('input', ()=>{
      const q = filter.value.trim().toLowerCase();
      function applyFilter(ul){
        let anyVisible = false;
        ul.querySelectorAll(':scope > li').forEach(li=>{
          const a = li.querySelector(':scope > .node a');
          const childUl = li.querySelector(':scope > ul');
          const selfMatch = (a?.textContent.toLowerCase() || '').includes(q);
          let childMatch = false;
          if(childUl){
            childMatch = applyFilter(childUl);
            // auto-open groups when matches are inside
            if(q) { childUl.hidden = false; li.querySelector(':scope > .node')?.classList.remove('collapsed'); }
          }
          const visible = !q || selfMatch || childMatch;
          li.style.display = visible ? '' : 'none';
          anyVisible = anyVisible || visible;
        });
        return anyVisible;
      }
      applyFilter(tocUl);
    });

    // 6) Expand / Collapse all
    document.getElementById('expandAll').addEventListener('click', ()=>{
      tocUl.querySelectorAll('ul').forEach(ul=>ul.hidden=false);
      tocUl.querySelectorAll('.node').forEach(n=>n.classList.remove('collapsed'));
    });
    document.getElementById('collapseAll').addEventListener('click', ()=>{
      tocUl.querySelectorAll(':scope > li > ul').forEach(ul=>{
        ul.querySelectorAll('ul').forEach(sul=>sul.hidden=true);
      });
      tocUl.querySelectorAll('.node').forEach(n=>n.classList.add('collapsed'));
      tocUl.querySelectorAll(':scope > li > .node').forEach(n=>n.classList.remove('collapsed'));
    });

    // 7) Active section highlight on scroll
    const links = Array.from(tocUl.querySelectorAll('a'));
    const byId = new Map(links.map(a=>[a.getAttribute('href').slice(1), a]));
    const obs = new IntersectionObserver(entries=>{
      entries.forEach(e=>{
        const id = e.target.id;
        const a = byId.get(id);
        if(!a) return;
        if(e.isIntersecting){
          links.forEach(x=>x.parentElement.classList.remove('active'));
          a.parentElement.classList.add('active');
        }
      });
    }, { rootMargin:'-40% 0px -55% 0px', threshold:[0,1] });
    headings.forEach(h=>{ h.classList.add('anchor-highlight'); obs.observe(h); });

    // 8) Smooth in-page scroll (no leaving index layout)
    document.addEventListener('click', (e)=>{
      const a = e.target.closest('a[href^="#"]');
      if(!a) return;
      const id = a.getAttribute('href').slice(1);
      const target = document.getElementById(id);
      if(target){
        e.preventDefault();
        target.scrollIntoView({behavior:'smooth', block:'start'});
        history.replaceState(null, '', '#'+id);
      }
    });
  })();
  </script>
</body>
</html>
