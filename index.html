<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jacob’s Theory — Phase 1: The Fall</title>
  <meta name="color-scheme" content="light dark" />
  <script defer data-domain="jacobstheory.github.io/jacobs-theory" src="https://plausible.io/js/script.file-downloads.js"></script>
  <style>
    :root{
      --bg:#0f1115;--panel:#141821;--ink:#e8eaf0;--muted:#a9b0be;
      --accent:#66d9ef;--accent-2:#8be9a8;--border:#212634;
      --link:#8bd5ff;--link-hover:#bce8ff;--active:#1e2635;
      --sidebar: clamp(240px, 22vw, 320px);      /* fluid sidebar width */
    }
    *{box-sizing:border-box}

    /* Frame (desktop): window static; only main scrolls */
    html,body{
      height:100%;
      overflow:hidden;
      margin:0;
      background:var(--bg); color:var(--ink);
      font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
    }

    /* Sidebar */
    aside{
      position:fixed; left:0; top:0; bottom:0; width:var(--sidebar);
      background:var(--panel); border-right:1px solid var(--border);
      padding:14px 12px; display:flex; flex-direction:column; overflow:hidden;
    }
    .brand{font-weight:700; letter-spacing:.2px; margin:0 0 6px}
    .hint{color:var(--muted); font-size:.85rem; margin:0 0 12px}

    /* Downloads (simple links) */
    .downloads{margin:10px 0 14px}
    .downloads h4{margin:0 0 6px; font-size:.9rem; letter-spacing:.3px; color:#cfe3ff}
    .downloads ul{list-style:disc; padding-left:18px; margin:6px 0 0}
    .downloads a{color:var(--link); text-decoration:none}
    .downloads a:hover{color:var(--link-hover); text-decoration:underline}

    /* Controls + filter */
    .controls{display:flex; gap:8px; margin:10px 0; flex-wrap:wrap}
    .btn{background:transparent; color:var(--muted); border:1px solid var(--border); padding:6px 8px; border-radius:8px; cursor:pointer; font-size:.85rem}
    .btn:hover{color:var(--ink); border-color:#2a3244}
    .filter{width:100%; padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:#0c0f14; color:var(--ink); margin-bottom:10px}

    /* TOC */
    nav#toc{flex:1; min-height:0; overflow:auto; padding-right:6px; -webkit-overflow-scrolling:touch; overscroll-behavior:contain}
    nav ul{list-style:none; margin:0; padding:0}
    nav li{margin:0; padding:0}
    .node{display:flex; align-items:center; gap:6px; width:100%; padding:6px 6px; border-radius:8px; cursor:pointer; border:1px solid transparent}
    .node:hover{background:#161c25}
    .node.active{background:var(--active); border-color:#263043}
    .node .chev{width:16px;height:16px;display:inline-flex;align-items:center;justify-content:center;color:var(--muted);transition:transform .15s}
    .collapsed>.chev{transform:rotate(-90deg)}
    .node a{color:var(--link); text-decoration:none; flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .node a:hover{color:var(--link-hover)}
    .level-1{margin-left:0} .level-2{margin-left:14px} .level-3{margin-left:28px}

    /* Content pane: fill remaining width (no right bar); only this scrolls */
    main{
      position:relative;
      margin-left:var(--sidebar);
      height:100svh; overflow:auto; -webkit-overflow-scrolling:touch;
      padding:34px 40px;
      width:calc(100vw - var(--sidebar));
      max-width:none; margin-right:0;
      scroll-behavior:smooth;
    }
    main h1,main h2,main h3{scroll-margin-top:18px}
    main a{color:var(--accent)}
    hr{border:0; border-top:1px solid var(--border); margin:26px 0}

    /* Heading highlight line */
    .anchor-highlight{position:relative}
    .anchor-highlight::before{content:""; position:absolute; left:-14px; top:9px; bottom:9px; width:3px; background:var(--accent-2); border-radius:3px; opacity:.4}

    /* Auto stacked mode when narrow (variable-based) */
    @media (max-width: calc(700px + var(--sidebar))) {
      html,body{overflow:auto}
      aside{position:static; width:auto; height:auto}
      nav#toc{max-height:50vh}
      main{margin-left:0; width:100%; max-width:100%; height:auto; overflow:visible}
    }
    /* Fallback stacked mode for older mobile browsers (no CSS var math in MQ) */
    @media (max-width: 1024px) {
      html,body{overflow:auto}
      aside{position:static; width:auto; height:auto}
      nav#toc{max-height:50vh}
      main{margin-left:0; width:100%; max-width:100%; height:auto; overflow:visible}
    }
  </style>
</head>
<body>
  <aside>
    <h3 class="brand">Contents</h3>

    <section class="downloads" aria-labelledby="downloads-title">
      <h4 id="downloads-title">Downloads</h4>
      <ul>
        <li><a href="Jacobs%20Theory%20-%20Phase%201%20The%20Fall.pdf" target="_blank" rel="noopener">Download PDF</a></li>
        <li><a href="Jacobs%20Theory%20-%20Phase%201%20The%20Fall%20-%20Unknown.epub" target="_blank" rel="noopener">Download EPUB</a></li>
      </ul>
    </section>

    <p class="hint">Auto-grouped by H1 → H2 → H3</p>
    <input id="filter" class="filter" placeholder="Filter headings…" aria-label="Filter headings">

    <div class="controls">
      <button class="btn" id="expandAll" type="button">Expand all</button>
      <button class="btn" id="collapseAll" type="button">Collapse all</button>
    </div>

    <nav id="toc" aria-label="Table of contents"><ul></ul></nav>
  </aside>

  <main id="content">
    <p style="color:#a9b0be">Loading content…</p>
  </main>

<script>
(async function(){
  const host = document.getElementById('content');
  try{
    const resp = await fetch('content.html', {cache:'no-store'});
    host.innerHTML = await resp.text();
  }catch(e){
    host.innerHTML = "<p style='color:#f88'>Could not load content.html</p>";
    return;
  }

  /* Gather headings and ensure stable IDs */
  const headings = Array.from(host.querySelectorAll('h1,h2,h3')).filter(h=>h.textContent.trim());
  const slugCounts = new Map();
  const slugify = s=>{
    const base = s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    const n = slugCounts.get(base)||0; slugCounts.set(base,n+1);
    return n ? `${base}-${n}` : base;
  };
  headings.forEach(h=>{ if(!h.id) h.id = slugify(h.textContent.trim()); });

  /* Build H1 > H2 > H3 tree */
  const levelOf = h => +h.tagName.substring(1);
  const root = {children:[], level:0}; let stack=[root];
  headings.forEach(h=>{
    const L = levelOf(h);
    const node = {level:L, text:h.textContent.trim(), id:h.id, children:[]};
    while(stack.length && stack.at(-1).level >= L) stack.pop();
    stack.at(-1).children.push(node);
    stack.push(node);
  });

  /* Render TOC */
  const tocUl = document.getElementById('toc').firstElementChild;
  function render(nodes, level, parentUl){
    nodes.forEach(node=>{
      const li = document.createElement('li');
      const row = document.createElement('div');
      row.className = `node level-${Math.min(level,3)}`;

      if(node.children.length){
        const chev = document.createElement('span');
        chev.className = 'chev'; chev.textContent = '▾';
        row.appendChild(chev);
      }else{
        const spacer = document.createElement('span');
        spacer.style.width = '16px';
        row.appendChild(spacer);
      }

      const a = document.createElement('a');
      a.href = '#'+node.id; a.textContent = node.text;
      row.appendChild(a);
      li.appendChild(row); parentUl.appendChild(li);

      if(node.children.length){
        const childUl = document.createElement('ul');
        childUl.hidden = false; li.appendChild(childUl);
        row.addEventListener('click', ev=>{
          if(ev.target.tagName.toLowerCase()==='a') return; // let links navigate
          childUl.hidden = !childUl.hidden;
          row.classList.toggle('collapsed', childUl.hidden);
        });
        render(node.children, level+1, childUl);
      }
    });
  }
  render(root.children, 1, tocUl);

  /* Filter (keeps parents if child matches) */
  const filter = document.getElementById('filter');
  filter.addEventListener('input', ()=>{
    const q = filter.value.trim().toLowerCase();
    function apply(ul){
      let any=false;
      Array.from(ul.children).forEach(li=>{
        if(li.tagName!=='LI') return;
        let row=null, childUl=null;
        for(const el of li.children){ if(el.classList?.contains('node')) row=el; if(el.tagName==='UL') childUl=el; }
        const a=row?.querySelector('a');
        const self=(a?.textContent.toLowerCase()||'').includes(q);
        let child=false;
        if(childUl){ child=apply(childUl); if(q){ childUl.hidden=false; row?.classList.remove('collapsed'); } }
        const show=!q || self || child;
        li.style.display=show?'':'none'; any=any||show;
      });
      return any;
    }
    apply(tocUl);
  });

  /* Expand All */
  document.getElementById('expandAll').addEventListener('click', ()=>{
    tocUl.querySelectorAll('ul').forEach(ul=>ul.hidden=false);
    tocUl.querySelectorAll('.node').forEach(row=>row.classList.remove('collapsed'));
  });

  /* Collapse All → show ONLY H1 rows (hide every nested UL) */
  document.getElementById('collapseAll').addEventListener('click', ()=>{
    // hide all child ULs (including each H1's direct UL)
    tocUl.querySelectorAll('ul').forEach(ul=>{
      if(ul!==tocUl) ul.hidden = true;
    });
    // set chevrons to collapsed for anything that has children
    tocUl.querySelectorAll('li').forEach(li=>{
      let row=null, directUl=null;
      for(const el of li.children){
        if(el.classList?.contains('node')) row=el;
        if(el.tagName==='UL'){ directUl=el; break; }
      }
      if(row) row.classList.toggle('collapsed', !!directUl);
    });
  });

  /* Active-section highlight — use main as root when it scrolls; else window */
  function getScrollRoot(){
    const style=getComputedStyle(host);
    const mainScrolls=(host.scrollHeight>host.clientHeight) && (style.overflowY==='auto' || style.overflowY==='scroll');
    return mainScrolls ? host : null;
  }
  const links = Array.from(document.querySelectorAll('#toc a'));
  const byId = new Map(links.map(a=>[a.getAttribute('href').slice(1), a]));
  const observer = new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      const a=byId.get(e.target.id); if(!a) return;
      if(e.isIntersecting){
        links.forEach(x=>x.parentElement.classList.remove('active'));
        a.parentElement.classList.add('active');
      }
    });
  }, { root:getScrollRoot(), rootMargin:'-40% 0px -55% 0px', threshold:[0,1] });
  headings.forEach(h=>{ h.classList.add('anchor-highlight'); observer.observe(h); });

  /* Smooth scroll that picks correct scroller (main vs window) */
  (function(){
    function scrollToEl(el){
      const root = getScrollRoot();  // null => window
      const offset = 12;
      if(root){
        const top = el.getBoundingClientRect().top - root.getBoundingClientRect().top + root.scrollTop - offset;
        root.scrollTo({top, behavior:'smooth'});
      }else{
        const top = el.getBoundingClientRect().top + (window.pageYOffset || document.documentElement.scrollTop) - offset;
        window.scrollTo({top, behavior:'smooth'});
      }
    }
    document.addEventListener('click', e=>{
      const a=e.target.closest('a[href^="#"]'); if(!a) return;
      const id=a.getAttribute('href').slice(1);
      const t=document.getElementById(id); if(!t) return;
      e.preventDefault();
      history.replaceState(null,'','#'+id);
      scrollToEl(t);
    });
    if(location.hash){
      const t=document.getElementById(location.hash.slice(1));
      if(t) setTimeout(()=>scrollToEl(t), 0);
    }
  })();
})();
</script>
</body>
</html>




